"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),STORAGE_KEY="<%= options.storageKey %>",VUEX_NAMESPACE="<%= options.vuexNamespace %>",LOGIN_URL="<%= options.loginUrl %>",LOGOUT_URL="<%= options.logoutUrl %>",ACCESS_TOKEN_KEY="<%= options.accessTokenKey %>",REFRESH_TOKEN_KEY="<%= options.refreshTokenKey %>",REFRESH_URL="<%= options.refreshUrl %>",REFRESH_USING_HEADER="<%= options.refreshUsingHeader %>",REFRESH_PERIOD=1e3*"<%= options.refreshPeriod %>",AUTH_STRATEGY="<%= options.authStrategy %>",AUTH_SCHEME="<%= options.authScheme %>",_attemptRefresh=function(a,b,c){return a.loginWith(AUTH_STRATEGY,{data:{refresh_token:c}})},state=function(){return{refreshInterval:null}},mutations={refreshInterval:function refreshInterval(a,b){a.refreshInterval&&clearInterval(a.refreshInterval),a.refreshInterval=b},refreshToken:function refreshToken(a,b){this.$auth.$storage.setUniversal(STORAGE_KEY,b)}},actions={initRefreshInterval:function initRefreshInterval(a){var b=a.dispatch;b("resetRefreshInterval",this.$auth.$storage.getUniversal(STORAGE_KEY))},resetRefreshInterval:function resetRefreshInterval(a,b){var c=a.dispatch,d=a.commit;c("stopRefreshInterval"),d("refreshToken",b);var e=function(){c("attemptRefresh")};setTimeout(function(){return d("refreshInterval",setInterval(e,REFRESH_PERIOD))},REFRESH_PERIOD/2)},stopRefreshInterval:function stopRefreshInterval(a){var b=a.commit;b("refreshInterval",null)},attemptRefresh:function attemptRefresh(a){var b,c,d,e;return _regenerator["default"].async(function(f){for(;;)switch(f.prev=f.next){case 0:if(b=a.dispatch,c=a.commit,d=this.$auth.$storage.getUniversal(STORAGE_KEY),d||REFRESH_USING_HEADER){f.next=4;break}throw new Error("Refresh token is required");case 4:return f.prev=4,f.next=7,_regenerator["default"].awrap(_attemptRefresh(this.$auth,this.$axios,d));case 7:e=f.sent,c("refreshToken",e[REFRESH_TOKEN_KEY]||null),f.next=19;break;case 11:if(f.prev=11,f.t0=f["catch"](4),b("stopRefreshInterval"),!this.$authRefresh._onErrorhandler){f.next=18;break}this.$authRefresh._onErrorhandler(f.t0),f.next=19;break;case 18:throw f.t0;case 19:case"end":return f.stop();}},null,this,[[4,11]])}},storeModule={state:state,actions:actions,mutations:mutations,namespaced:!0},_default=function(a,b){var c=a.$axios,d=a.store;d.registerModule(VUEX_NAMESPACE,storeModule,{preserveState:!!d.state[VUEX_NAMESPACE]}),c.interceptors.response.use(function(a){return-1!==a.config.url.indexOf(LOGIN_URL)&&d.dispatch(VUEX_NAMESPACE+"/resetRefreshInterval",a.data[REFRESH_TOKEN_KEY]||null),a}),c.interceptors.response.use(function(a){return-1!==a.config.url.indexOf(LOGOUT_URL)&&d.dispatch(VUEX_NAMESPACE+"/stopRefreshInterval"),a}),b("authRefresh",{_onErrorhandler:null,initRefreshInterval:function initRefreshInterval(){d.dispatch(VUEX_NAMESPACE+"/initRefreshInterval")},onRefreshError:function onRefreshError(a){this._onErrorhandler=a}})};exports["default"]=_default;